### 7.1 了解x86保护模式中的特权级

1. X86有几个特权级？

x86CPU支持4个特权级，而操作系统通常只使用2个特权级。

2. 不同特权级有什么区别？

一些特权指令只能在ring 0特权级执行，在不同特权级下，指令所能访问的数据空间是不同的，通常高特权级能够访问的数据空间更大。同一条指令在不同特权级下也会有不同的行为。

3. 请说明CPL、DPL和RPL在中断响应、函数调用和指令执行时的作用。

中断响应和系统调用访问相关的门时能够从低优先级代码访问高优先级服务，即(CPL >= DPL),访问段时，只能从高优先级代码访问低优先级数据，从而提供了保护机制。

### 7.2 了解特权级切换过程

1. 一条指令在执行时会有哪些可能的特权级判断？

当指令需要访问数据时，判断响应的数据段能否在当前特权级访问。跳转指令跳转到一个新的地址时，同样需要判断段是否能被访问。执行某些特权级指令时，要判断当前特权级是否有权限执行这些特权指令。当发生中断响应和系统调用时，访问对应的中断门页需要特权级判断。

2. 在什么情况下会出现特权级切换？

用户态执行过程中产生了中断或异常，需要切换到内核态进行中断处理。用户态通过INT指令请求系统调用会切换到内核态完成服务。内核态处理完中断响应或系统调用后切换特权级返回到用户态。

3. int指令在ring0和ring3的执行行为有什么不同？

在ring3特权级执行需要额外把当前要用户进程的执行状态进行压栈，即SS：ESP寄存器，且当前栈空间会由用户栈切换到内核栈，而ring0特权级下执行int指令不需要这些操作。

4. 如何利用int和iret指令完成不同特权级的切换？

执行INT指令时将特权级转换时需要的寄存器信息在内存上栈空间保存，并且根据需要设置返回地址，执行IRET指令时将这些信息恢复，从而完成特权级的切换。

5. TSS和Task Register的作用是什么？

TSS在任务（进程）切换时起着重要的作用，通过它保存CPU中各寄存器的值，实现任务的挂起和恢复。比如说，当CPU执行A进程的时间片用完，要切换到B进程时，CPU会先把当前寄存器里的值保存到A进程的TSS里（任务寄存器TR指向当前进程的TSS），比如CS，EIP，ESP，标志寄存器等等，然后挂起A进程。执行B进程。这样，在CPU下次执行A进程的时候，就可以从其TSS中取出，CPU就知道上一次A进程执行到了什么位置，执行状态等等，这样就恢复了上次A进程的执行现场。

而任务寄存器指向了当前任务的TSS，使得CPU能够快速地访问当前任务的TSS。

 > [Task state segment](https://en.wikipedia.org/wiki/Task_state_segment)

 > Reference: [Intel® 64 and IA-32 Architectures Software Developer Manuals](http://os.cs.tsinghua.edu.cn/oscourse/OS2017spring/lecture04?action=AttachFile&do=view&target=325462-sdm-vol-1-2abcd-3abcd.pdf) Page 2897/4684: 7.2.1 Task-State Segment (TSS)

### 7.3 了解段/页表

1. 一条指令执行时最多会出现多少次地址转换？

每次访问数据首先要通过段选择子到相应段将虚拟地址转换为线性地址，然后查阅页表再将线性地址转换为物理地址。这是两次地址转换。对于运算形指令或转移形指令，其一条指令可以访问两个操作数，所以一共可能需要4次地址转换。

2. 描述X86-32的MMU地址转换过程；

首先根据段寄存器中的段选择子利用GDT或LDT找到段所在地址，并从段描述符中取出段的基址和最大偏移量。检查偏移量是否超出段空间后，将基址加上偏移量得到线性地址。从CR3寄存器中获取页目录表地址，完成第一级页地址映射，获得页表所在地址，再区页表中从PTE中得到物理页的基址，加上偏移量得到最后的物理地址。