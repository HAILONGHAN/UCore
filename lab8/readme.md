# Lab8 report

## 练习一

### 完成读文件操作的实现


要实现文件的打开，首先需要处理起始处没有对齐到块的部分，再以块为单位循环处理中间部分，最后处理末尾剩余部分。每部分的处理都调用sfs_bmap_load_nolock函数得到blkno对应的inode编号，并调用sfs_rbuf或sfs_rblock函数读取数据（中间部分调用sfs_rblock，起始和末尾部分调用sfs_rbuf），调整相关变量即可。

具体实现见代码。

给出设计实现”UNIX的PIPE机制“的概要设方案，鼓励给出详细设计方案

可以设计一个pipe用的pipefs，在系统调用时创建两个file，一个只读，一个只写，并使这两个file连接到同一个inode上。这样便简单实现了pipe机制，使用一个临时保存输出的文件，当程序1输出时，将内存保存到这个文件；当程序2读入时，读取这个文件的内容即可。

## 练习二

### 完成基于文件系统的执行程序机制的实现

proc.c中需要做如下修改：

- alloc_proc()

增加对于filesp内容的初始化。

- do_fork()

增加对于filesp的复制处理。直接调用实现好的函数即可。

- load_icode()

首先需要为新进程创建mm和PDT，这和之前的实现一致。然后要调用load_icode_read加载elf格式文件，并进行magic_number的判断。接着对于每一个程序段如下完成操作：load_icode_read加载程序起始段，创建vma，分配内存，读入程序段。最后进行堆栈分配，设置mm，cr3等寄存器，并将argc和argv的值放入栈中，设置trapframe即可。

具体实现见代码。

### 硬链接和软链接设计

创建硬链接时，需要操作系统产生一个新的inode，其内容和之前的inode相同并增加引用计数。创建软连接时，相当于一个快捷方式，只需要将它设置为一个指针，指向原来的文件即可。

